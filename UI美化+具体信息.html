<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>èˆ¹èˆ¶è®¢å•åŠ¨æ€æµå‘å›¾</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.0/dist/echarts.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts/map/js/world.js"></script>
    <style>
        /* ä¿æŒåŸæœ‰æ ·å¼ä¸å˜ */
        html, body { height: 100%; margin: 0; overflow: hidden; }
        .container { display: flex; flex-direction: column; height: 100%; }
        #map-container { flex: 1; position: relative; }
        #container { width: 100%; height: 100%; }
        #timeline {
            height: 100px;
            background: linear-gradient(180deg, #f0f5ff, #e0ebff);
            box-shadow: 0 -2px 8px rgba(64, 158, 255, 0.1);
            padding: 10px 20px;
            margin-top: 5px;
        }

        #legend {
            position: fixed;
            top: 10px;
            left: 10px;
            background: white;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 0 5px rgba(0,0,0,0.3);
            font-size: 14px;
            z-index: 998;
        }

        #stats-container {
            position: fixed;
            top: 10px;
            right: 10px;
            width: 200px;
            height: 250px;
            z-index: 999;
        }

        #stats {
            width: 100%;
            height: 100%;
            background: white;
            border-radius: 5px;
            box-shadow: 0 0 5px rgba(0,0,0,0.3);
        }

        /* æ–°å¢è®¢å•è¯¦æƒ…é¢æ¿æ ·å¼ */
        #order-details {
            position: fixed;
            bottom: 120px;
            left: 20px;
            background: white;
            padding: 15px;
            border-radius: 6px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            max-width: 300px;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transform: translateY(10px);
            transition: all 0.3s ease;
            font-size: 14px;
            line-height: 1.6;
        }

        #order-details.show {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        #order-details h3 {
            margin: 0 0 10px;
            color: #333;
            border-bottom: 1px solid #eee;
            padding-bottom: 8px;
        }

        #order-details p {
            margin: 5px 0;
            color: #666;
        }

        #order-details .close-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            cursor: pointer;
            color: #999;
            font-size: 16px;
        }

        #order-details .close-btn:hover {
            color: #333;
        }

        #order-details .ship-type {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 6px;
        }

        /* æ–°å¢èˆ¹å‹ç­›é€‰é¢æ¿æ ·å¼ */
        #ship-type-filter {
            position: fixed;
            top: 10px;
            left: 200px;
            background: white;
            padding: 10px 15px;
            border-radius: 5px;
            box-shadow: 0 0 5px rgba(0,0,0,0.3);
            font-size: 14px;
            z-index: 998;
        }

        #ship-type-filter h3 {
            margin: 0 0 8px;
            font-size: 14px;
            color: #333;
        }

        #ship-type-filter ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        #ship-type-filter li {
            margin-bottom: 6px;
            display: flex;
            align-items: center;
        }

        #ship-type-filter input[type="checkbox"] {
            margin-right: 8px;
            cursor: pointer;
        }

        #ship-type-filter .color-dot {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 6px;
        }

        #ship-type-filter label {
            cursor: pointer;
            user-select: none;
        }

        /* çŠ¶æ€æç¤º */
        #filter-status {
            position: fixed;
            bottom: 10px;
            right: 10px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 12px;
            z-index: 999;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        #filter-status.show {
            opacity: 1;
        }

        .error { color: red; padding: 10px; text-align: center; }
    </style>
</head>
<body>
    <div class="container">
        <div id="map-container">
            <div id="container"></div>
            <div id="legend">
                <strong>èˆ¹å‹å›¾ä¾‹</strong>
                <ul>
                    <li style="color:#409EFF;">ğŸŸ¦ é›†è£…ç®±èˆ¹</li>
                    <li style="color:#FF6B6B;">ğŸŸ¥ æ²¹èˆ¹</li>
                    <li style="color:#00BFA5;">ğŸŸ© æ°”ä½“èˆ¹</li>
                    <li style="color:#FFD166;">ğŸŸ¨ æ•£è´§èˆ¹</li>
                    <li style="color:#909399;">â¬œ å…¶ä»–</li>
                </ul>
            </div>
            <!-- æ–°å¢èˆ¹å‹ç­›é€‰é¢æ¿ -->
            <div id="ship-type-filter">
                <h3>èˆ¹å‹ç­›é€‰</h3>
                <ul>
                    <li>
                        <input type="checkbox" id="filter-container" checked onchange="updateFilters()">
                        <span class="color-dot" style="background-color: #409EFF;"></span>
                        <label for="filter-container">é›†è£…ç®±èˆ¹</label>
                    </li>
                    <li>
                        <input type="checkbox" id="filter-oil" checked onchange="updateFilters()">
                        <span class="color-dot" style="background-color: #FF6B6B;"></span>
                        <label for="filter-oil">æ²¹èˆ¹</label>
                    </li>
                    <li>
                        <input type="checkbox" id="filter-gas" checked onchange="updateFilters()">
                        <span class="color-dot" style="background-color: #00BFA5;"></span>
                        <label for="filter-gas">æ°”ä½“èˆ¹</label>
                    </li>
                    <li>
                        <input type="checkbox" id="filter-bulk" checked onchange="updateFilters()">
                        <span class="color-dot" style="background-color: #FFD166;"></span>
                        <label for="filter-bulk">æ•£è´§èˆ¹</label>
                    </li>
                    <li>
                        <input type="checkbox" id="filter-other" checked onchange="updateFilters()">
                        <span class="color-dot" style="background-color: #909399;"></span>
                        <label for="filter-other">å…¶ä»–</label>
                    </li>
                </ul>
                <button onclick="resetFilters()" style="margin-top: 8px; width: 100%; padding: 4px; font-size: 12px;">é‡ç½®ç­›é€‰</button>
            </div>
            <!-- æ–°å¢ç­›é€‰çŠ¶æ€æç¤º -->
            <div id="filter-status" class="show">
                æ˜¾ç¤ºå…¨éƒ¨èˆ¹å‹
            </div>
            <div id="stats-container">
                <div id="stats"></div>
            </div>
            <!-- è®¢å•è¯¦æƒ…é¢æ¿ -->
            <div id="order-details">
                <span class="close-btn" onclick="hideOrderDetails()">&times;</span>
                <h3>è®¢å•è¯¦æƒ…</h3>
                <p><strong>èˆ¹ä¸œ:</strong> <span id="detail-shipowner"></span></p>
                <p><strong>èˆ¹å‚:</strong> <span id="detail-shipyard"></span></p>
                <p><strong>èˆ¹å‹:</strong> <span class="ship-type" id="detail-ship-type"></span><span id="detail-ship-type-text"></span></p>
                <p><strong>æ•°é‡:</strong> <span id="detail-quantity"></span></p>
                <p><strong>æ—¥æœŸ:</strong> <span id="detail-date"></span></p>
                <p><strong>å›½å®¶:</strong> <span id="detail-country"></span></p>
            </div>
        </div>
        <div id="timeline"></div>
    </div>
    <div class="error" id="errorMsg"></div>

    <script>
        // å…¨å±€å˜é‡
        let globalProcessedData = [];
        let currentChart = null;
        let currentTimeline = null;
        let currentStatsChart = null;
        let currentSelectedRange = null;

        // ç­›é€‰çŠ¶æ€
        let filterStatus = {
            'é›†è£…ç®±èˆ¹': true,
            'æ²¹èˆ¹': true,
            'æ°”ä½“èˆ¹': true,
            'æ•£è´§èˆ¹': true,
            'å…¶ä»–': true
        };

        window.onload = function() {
            fetch('https://xyd0916.github.io/lakes/ä¸­éŸ©.json')
                .then(response => response.json())
                .then(data => processData(data))
                .catch(error => handleError(error));
        };

        function handleError(error) {
            console.error("æ•°æ®åŠ è½½å¤±è´¥:", error);
            document.getElementById('errorMsg').textContent = "æ•°æ®åŠ è½½å¤±è´¥: " + error.message;
        }

        function processData(excelData) {
            if (!excelData || excelData.length === 0) {
                throw new Error('é”™è¯¯ï¼šæ•°æ®ä¸ºç©ºï¼');
            }
            console.log("è®¢å•æ•°æ®åŠ è½½æˆåŠŸï¼");

            const colorMap = {
                'é›†è£…ç®±èˆ¹': '#409EFF',
                'æ²¹èˆ¹': '#FF6B6B',
                'æ°”ä½“èˆ¹': '#00BFA5',
                'æ•£è´§èˆ¹': '#FFD166',
                'å…¶ä»–': '#909399',
            };

            const processedData = excelData.map(item => ({
                ...item,
                timestamp: new Date(item.date).getTime(),
                shipownerX: parseFloat(item.shipownerX),
                shipyardX: parseFloat(item.shipyardX),
                shipownerY: parseFloat(item.shipownerY),
                shipyardY: parseFloat(item.shipyardY),
                lineWidth: Math.max(1, parseFloat(item.quantity) / 3),
                color: colorMap[item.shipType] || colorMap['å…¶ä»–'],
                shipType: item.shipType || 'å…¶ä»–',
                country: item.å›½å®¶ // è·å–èˆ¹å‚æ‰€åœ¨å›½å®¶
            }));

            // å­˜å‚¨å¤„ç†åçš„æ•°æ®åˆ°å…¨å±€å˜é‡
            globalProcessedData = processedData;

            console.log("å¤„ç†åçš„æ•°æ®:", processedData);

            // åˆå§‹åŒ–å›¾è¡¨
            currentChart = echarts.init(document.getElementById('container'));
            currentTimeline = echarts.init(document.getElementById('timeline'));
            currentStatsChart = echarts.init(document.getElementById('stats'));

            const uniqueDates = Array.from(new Set(processedData.map(d => d.date))).sort();
            console.log("æ—¶é—´è½´æ•°æ®:", uniqueDates);

            // æ ¼å¼åŒ–æ—¥æœŸå‡½æ•°
            function formatDate(dateString) {
                if (!dateString) return '';
                const date = new Date(dateString);
                if (!isNaN(date.getTime())) {
                    return date.toISOString().split('T')[0];
                }
                if (typeof dateString === 'string') {
                    const dateParts = dateString.split(/[\/\-\s]/);
                    if (dateParts.length >= 3) {
                        return dateParts[0] + '-' + dateParts[1] + '-' + dateParts[2];
                    }
                    if (dateString.includes(' ')) {
                        return dateString.split(' ')[0];
                    }
                }
                return dateString;
            }

            // ç¾åŒ–æ—¶é—´è½´
            currentTimeline.setOption({
                title: {
                    text: 'è®¢å•æ—¶é—´è½´',
                    left: 'center',
                    textStyle: {
                        color: '#333',
                        fontSize: 14,
                        fontWeight: 'bold'
                    }
                },
                tooltip: {
                    formatter: params => formatDate(params.name),
                    backgroundColor: 'rgba(255,255,255,0.9)',
                    borderColor: '#409EFF',
                    borderWidth: 1,
                    padding: 8,
                    textStyle: {
                        color: '#333',
                        fontSize: 12
                    }
                },
                dataZoom: [{
                    type: 'slider',
                    start: 0,
                    end: 10,
                    backgroundColor: 'rgba(224, 235, 255, 0.5)',
                    fillerColor: 'rgba(64, 158, 255, 0.2)',
                    borderColor: '#409EFF',
                    handleStyle: {
                        color: '#409EFF',
                        borderColor: '#fff',
                        shadowBlur: 2,
                        shadowColor: 'rgba(0,0,0,0.2)'
                    },
                    textStyle: {
                        color: '#666'
                    }
                }],
                xAxis: {
                    type: 'category',
                    data: uniqueDates,
                    axisLine: {
                        show: true,
                        lineStyle: {
                            color: '#b3d0ff',
                            width: 1
                        }
                    },
                    axisTick: {
                        show: true,
                        alignWithLabel: true,
                        lineStyle: {
                            color: '#b3d0ff'
                        }
                    },
                    axisLabel: {
                        rotate: 0,
                        margin: 15,
                        interval: 'auto',
                        formatter: function(value) {
                            // ç®€åŒ–æ—¥æœŸæ˜¾ç¤ºæ ¼å¼ï¼Œåªæ˜¾ç¤ºæœˆ-æ—¥
                            const date = new Date(value);
                            if (!isNaN(date.getTime())) {
                                return (date.getMonth() + 1) + '-' + date.getDate();
                            }
                            return value;
                        },
                        textStyle: {
                            color: '#666',
                            fontSize: 12
                        }
                    }
                },
                yAxis: {
                    show: false
                },
                series: [{
                    type: 'line',
                    showSymbol: false,
                    lineStyle: {
                        color: '#409EFF',
                        width: 2,
                        opacity: 0.8
                    },
                    areaStyle: {
                        color: {
                            type: 'linear',
                            x: 0,
                            y: 0,
                            x2: 0,
                            y2: 1,
                            colorStops: [{
                                offset: 0, color: 'rgba(64, 158, 255, 0.2)' // 0% å¤„çš„é¢œè‰²
                            }, {
                                offset: 1, color: 'rgba(64, 158, 255, 0)' // 100% å¤„çš„é¢œè‰²
                            }],
                            global: false // ç¼ºçœä¸º false
                        }
                    }
                }]
            });

            currentChart.setOption({
                title: { text: 'å…¨çƒèˆ¹èˆ¶è®¢å•åŠ¨æ€æµå‘å›¾', left: 'center' },
                geo: {
                    map: 'world',
                    roam: true,
                    itemStyle: {
                        areaColor: '#e6f0ff', // æ·¡è“è‰²æµ·æ´‹èƒŒæ™¯
                        borderColor: '#b3d0ff', // æµ…è“å›½ç•Œçº¿
                        emphasis: {
                            areaColor: '#d0e5ff' // æ‚¬åœæ—¶åŠ æ·±
                        }
                    },
                    zoom: 1.1, // ç¼©å°åˆå§‹è§†è§’
                    center: [15, 30], // åœ°å›¾ä¸­å¿ƒç•¥åä¸œ
                    label: {
                        show: false // éšè—å›½å®¶æ–‡å­—æ ‡ç­¾
                    }
                },
                series: [
                    // è½¨è¿¹çº¿ç³»åˆ— - å¸¦å°¾è¿¹å’ŒåŠ¨ç”»æ•ˆæœ
                    {
                        type: 'lines',
                        coordinateSystem: 'geo',
                        effect: {
                            show: true,
                            symbol: 'circle', // ç®­å¤´ç¬¦å·æ”¹ä¸ºåœ†å½¢
                            symbolSize: 6, // ç¼©å°ç¬¦å·å°ºå¯¸
                            color: '#ffffff', // å°¾è¿¹å…‰æ™•ç™½è‰²
                            trailLength: 0.6, // ç¼©çŸ­å°¾è¿¹é•¿åº¦
                            period: 3, // å»¶é•¿åŠ¨ç”»å‘¨æœŸ
                            constantSpeed: 40, // é™ä½ç§»åŠ¨é€Ÿåº¦
                            shadowBlur: 8 // æ·»åŠ é«˜æ–¯æ¨¡ç³Šå…‰æ™•
                        },
                        lineStyle: {
                            normal: {
                                width: 1.2, // åŠ ç²—è½¨è¿¹çº¿
                                opacity: 0.8, // æé«˜é€æ˜åº¦
                                curveness: 0.2, // å‡å°‘å¼¯æ›²åº¦
                                color: 'rgba(64, 158, 255, 0.3)' // åŠé€æ˜ä¸»è‰²è°ƒ
                            }
                        },
                        data: []
                    },
                    // èˆ¹ä¸œåˆå§‹ä½ç½®ç‚¹ç³»åˆ— - å¸¦è„‰å†²æ•ˆæœ
                    {
                        type: 'effectScatter',
                        coordinateSystem: 'geo',
                        zlevel: 11,
                        rippleEffect: {
                            brushType: 'fill', // è„‰å†²æ”¹ä¸ºå¡«å……æ¨¡å¼
                            scale: 3, // ç¼©å°æ‰©æ•£èŒƒå›´
                            period: 5, // å»¶é•¿è„‰å†²å‘¨æœŸ
                            color: 'rgba(64, 158, 255, 0.2)' // åŠé€æ˜è„‰å†²è‰²
                        },
                        symbolSize: 8, // ç¼©å°ç‚¹å°ºå¯¸
                        itemStyle: {
                            borderWidth: 2, // æ·»åŠ ç™½è‰²æè¾¹
                            borderColor: '#ffffff'
                        },
                        data: []
                    },
                    // èˆ¹å‚ä½ç½®ç‚¹ç³»åˆ— - å¸¦è„‰å†²æ•ˆæœ
                    {
                        type: 'effectScatter',
                        coordinateSystem: 'geo',
                        zlevel: 12,
                        rippleEffect: {
                            brushType: 'fill', // è„‰å†²æ”¹ä¸ºå¡«å……æ¨¡å¼
                            scale: 3, // ç¼©å°æ‰©æ•£èŒƒå›´
                            period: 5, // å»¶é•¿è„‰å†²å‘¨æœŸ
                            color: 'rgba(255, 107, 107, 0.2)' // åŠé€æ˜è„‰å†²è‰²
                        },
                        symbolSize: 8, // ç¼©å°ç‚¹å°ºå¯¸
                        itemStyle: {
                            borderWidth: 2, // æ·»åŠ ç™½è‰²æè¾¹
                            borderColor: '#ffffff'
                        },
                        data: []
                    }
                ]
            });

            // åˆå§‹åŒ–ç»Ÿè®¡å›¾è¡¨
            currentStatsChart.setOption({
                title: { text: 'è®¢å•ç»Ÿè®¡', left: 'center' },
                legend: { data: ['ä¸­å›½', 'éŸ©å›½', 'æ—¥æœ¬'], bottom: 10, left: 'center' },
                tooltip: { trigger: 'axis', axisPointer: { type: 'shadow' } },
                polar: { radius: '70%' },
                angleAxis: {
                    type: 'category',
                    data: ['é›†è£…ç®±èˆ¹', 'æ²¹èˆ¹', 'æ°”ä½“èˆ¹', 'æ•£è´§èˆ¹', 'å…¶ä»–'],
                    boundaryGap: false,
                    startAngle: 90
                },
                radiusAxis: { type: 'value' },
                series: [
                    { type: 'bar', data: [], coordinateSystem: 'polar', stack: 'æ€»é‡', name: 'ä¸­å›½', itemStyle: { color: '#409EFF' } },
                    { type: 'bar', data: [], coordinateSystem: 'polar', stack: 'æ€»é‡', name: 'éŸ©å›½', itemStyle: { color: '#FF6B6B' } },
                    { type: 'bar', data: [], coordinateSystem: 'polar', stack: 'æ€»é‡', name: 'æ—¥æœ¬', itemStyle: { color: '#00BFA5' } }
                ]
            });

            function updateChart(selectedDate) {
                // åº”ç”¨ç­›é€‰æ¡ä»¶
                const filteredData = globalProcessedData.filter(d =>
                    d.date === selectedDate && filterStatus[d.shipType]
                );

                // å¤„ç†è½¨è¿¹çº¿æ•°æ®
                const lineData = filteredData.map(d => ({
                    fromName: d.èˆ¹ä¸œ,
                    toName: d.èˆ¹å‚,
                    coords: [[d.shipownerX, d.shipownerY], [d.shipyardX, d.shipyardY]],
                    lineStyle: {
                        color: d.color,
                        width: d.lineWidth * 0.8
                    },
                    effect: {
                        symbolSize: d.lineWidth * 2,
                        color: d.color,
                        trailWidth: d.lineWidth,
                        trailColor: d.color
                    },
                    originalData: d
                }));

                // å¤„ç†èˆ¹ä¸œä½ç½®æ•°æ®
                const shipownerPoints = filteredData.map(d => ({
                    name: d.èˆ¹ä¸œ,
                    value: [d.shipownerX, d.shipownerY],
                    itemStyle: {
                        color: d.color
                    }
                }));

                // å¤„ç†èˆ¹å‚ä½ç½®æ•°æ®
                const shipyardPoints = filteredData.map(d => ({
                    name: d.èˆ¹å‚,
                    value: [d.shipyardX, d.shipyardY],
                    itemStyle: {
                        color: d.color
                    }
                }));

                currentChart.setOption({
                    series: [
                        { name: 'è®¢å•è½¨è¿¹', data: lineData },
                        { name: 'èˆ¹ä¸œä½ç½®', data: shipownerPoints },
                        { name: 'èˆ¹å‚ä½ç½®', data: shipyardPoints }
                    ]
                });

                updateStats(selectedDate);
            }

            function showOrdersInRange(startIndex, endIndex) {
                const uniqueDates = Array.from(new Set(globalProcessedData.map(d => d.date))).sort();
                const selectedRange = uniqueDates.slice(startIndex, endIndex + 1);
                currentSelectedRange = selectedRange;

                // åº”ç”¨ç­›é€‰æ¡ä»¶
                const filteredData = globalProcessedData.filter(d =>
                    selectedRange.includes(d.date) && filterStatus[d.shipType]
                );

                // å¤„ç†è½¨è¿¹çº¿æ•°æ®
                const lineData = filteredData.map(d => ({
                    fromName: d.èˆ¹ä¸œ,
                    toName: d.èˆ¹å‚,
                    coords: [[d.shipownerX, d.shipownerY], [d.shipyardX, d.shipyardY]],
                    lineStyle: {
                        color: d.color,
                        width: d.lineWidth * 0.8
                    },
                    effect: {
                        symbolSize: d.lineWidth * 2,
                        color: d.color,
                        trailWidth: d.lineWidth,
                        trailColor: d.color
                    },
                    originalData: d
                }));

                // å¤„ç†èˆ¹ä¸œä½ç½®æ•°æ®
                const shipownerPoints = filteredData.map(d => ({
                    name: d.èˆ¹ä¸œ,
                    value: [d.shipownerX, d.shipownerY],
                    itemStyle: {
                        color: d.color
                    }
                }));

                // å¤„ç†èˆ¹å‚ä½ç½®æ•°æ®
                const shipyardPoints = filteredData.map(d => ({
                    name: d.èˆ¹å‚,
                    value: [d.shipyardX, d.shipyardY],
                    itemStyle: {
                        color: d.color
                    }
                }));

                currentChart.setOption({
                    series: [
                        { name: 'è®¢å•è½¨è¿¹', data: lineData },
                        { name: 'èˆ¹ä¸œä½ç½®', data: shipownerPoints },
                        { name: 'èˆ¹å‚ä½ç½®', data: shipyardPoints }
                    ]
                });

                updateStats(selectedRange);
            }

            function updateStats(dateOrRange) {
                const isRange = Array.isArray(dateOrRange);
                // åº”ç”¨ç­›é€‰æ¡ä»¶
                const filteredData = globalProcessedData.filter(d =>
                    (isRange ? dateOrRange.includes(d.date) : d.date === dateOrRange) &&
                    filterStatus[d.shipType]
                );

                const shipTypes = ['é›†è£…ç®±èˆ¹', 'æ²¹èˆ¹', 'æ°”ä½“èˆ¹', 'æ•£è´§èˆ¹', 'å…¶ä»–'];
                const countries = ['ä¸­å›½', 'éŸ©å›½', 'æ—¥æœ¬'];
                const countryData = {};

                countries.forEach(country => {
                    countryData[country] = shipTypes.map(() => 0);
                });

                filteredData.forEach(d => {
                    const shipTypeIndex = shipTypes.indexOf(d.shipType) !== -1 ?
                        shipTypes.indexOf(d.shipType) : shipTypes.indexOf('å…¶ä»–');

                    if (countries.includes(d.country)) {
                        countryData[d.country][shipTypeIndex]++;
                    }
                });

                currentStatsChart.setOption({
                    title: {
                        text: isRange ?
                            `è®¢å•ç»Ÿè®¡ (${dateOrRange.length}å¤©)` :
                            `è®¢å•ç»Ÿè®¡ (${formatDate(dateOrRange)})`
                    },
                    series: [
                        { data: countryData['ä¸­å›½'] },
                        { data: countryData['éŸ©å›½'] },
                        { data: countryData['æ—¥æœ¬'] }
                    ]
                });
            }

            // æ—¶é—´è½´äº‹ä»¶ç›‘å¬
            currentTimeline.on('click', params => {
                const uniqueDates = Array.from(new Set(globalProcessedData.map(d => d.date))).sort();
                updateChart(uniqueDates[params.dataIndex]);
            });

            currentTimeline.on('dataZoom', params => {
                const uniqueDates = Array.from(new Set(globalProcessedData.map(d => d.date))).sort();
                const startIndex = Math.round(params.start / 100 * uniqueDates.length);
                const endIndex = Math.round(params.end / 100 * uniqueDates.length);
                showOrdersInRange(startIndex, endIndex);
            });

            // æ—¶é—´è½´é¼ æ ‡æ‚¬åœæ•ˆæœ
            currentTimeline.on('mouseover', params => {
                currentTimeline.dispatchAction({
                    type: 'highlight',
                    seriesIndex: 0,
                    dataIndex: params.dataIndex
                });
            });

            currentTimeline.on('mouseout', () => {
                currentTimeline.dispatchAction({ type: 'downplay' });
            });

            // è½¨è¿¹çº¿ç‚¹å‡»äº‹ä»¶
            currentChart.on('click', function(params) {
                if (params.seriesName === 'è®¢å•è½¨è¿¹' && params.data.originalData) {
                    const orderData = params.data.originalData;
                    showOrderDetails(orderData);
                }
            });

            // åœ°å›¾èƒŒæ™¯ç‚¹å‡»äº‹ä»¶
            currentChart.on('click', function(params) {
                if (params.componentType === 'geo') {
                    hideOrderDetails();
                }
            });

            // åˆå§‹æ˜¾ç¤ºéƒ¨åˆ†æ•°æ®
            showOrdersInRange(0, Math.round(uniqueDates.length * 0.1));
        }

        // æ›´æ–°ç­›é€‰æ¡ä»¶
        function updateFilters() {
            filterStatus = {
                'é›†è£…ç®±èˆ¹': document.getElementById('filter-container').checked,
                'æ²¹èˆ¹': document.getElementById('filter-oil').checked,
                'æ°”ä½“èˆ¹': document.getElementById('filter-gas').checked,
                'æ•£è´§èˆ¹': document.getElementById('filter-bulk').checked,
                'å…¶ä»–': document.getElementById('filter-other').checked
            };

            // æ˜¾ç¤ºç­›é€‰çŠ¶æ€
            updateFilterStatus();

            // å¦‚æœæœ‰å½“å‰é€‰ä¸­çš„æ—¶é—´èŒƒå›´ï¼Œé‡æ–°åº”ç”¨ç­›é€‰
            if (currentSelectedRange) {
                const uniqueDates = Array.from(new Set(globalProcessedData.map(d => d.date))).sort();
                const startIndex = uniqueDates.indexOf(currentSelectedRange[0]);
                const endIndex = uniqueDates.indexOf(currentSelectedRange[currentSelectedRange.length - 1]);
                if (startIndex !== -1 && endIndex !== -1) {
                    showOrdersInRange(startIndex, endIndex);
                }
            }
        }

        // é‡ç½®ç­›é€‰æ¡ä»¶
        function resetFilters() {
            document.getElementById('filter-container').checked = true;
            document.getElementById('filter-oil').checked = true;
            document.getElementById('filter-gas').checked = true;
            document.getElementById('filter-bulk').checked = true;
            document.getElementById('filter-other').checked = true;

            filterStatus = {
                'é›†è£…ç®±èˆ¹': true,
                'æ²¹èˆ¹': true,
                'æ°”ä½“èˆ¹': true,
                'æ•£è´§èˆ¹': true,
                'å…¶ä»–': true
            };

            // æ˜¾ç¤ºç­›é€‰çŠ¶æ€
            updateFilterStatus();

            // å¦‚æœæœ‰å½“å‰é€‰ä¸­çš„æ—¶é—´èŒƒå›´ï¼Œé‡æ–°åº”ç”¨ç­›é€‰
            if (currentSelectedRange) {
                const uniqueDates = Array.from(new Set(globalProcessedData.map(d => d.date))).sort();
                const startIndex = uniqueDates.indexOf(currentSelectedRange[0]);
                const endIndex = uniqueDates.indexOf(currentSelectedRange[currentSelectedRange.length - 1]);
                if (startIndex !== -1 && endIndex !== -1) {
                    showOrdersInRange(startIndex, endIndex);
                }
            }
        }

        // æ›´æ–°ç­›é€‰çŠ¶æ€æç¤º
        function updateFilterStatus() {
            const statusEl = document.getElementById('filter-status');
            const activeFilters = Object.keys(filterStatus).filter(type => filterStatus[type]);

            if (activeFilters.length === Object.keys(filterStatus).length) {
                statusEl.textContent = 'æ˜¾ç¤ºå…¨éƒ¨èˆ¹å‹';
            } else if (activeFilters.length === 0) {
                statusEl.textContent = 'æœªé€‰æ‹©ä»»ä½•èˆ¹å‹';
            } else {
                statusEl.textContent = `æ˜¾ç¤º: ${activeFilters.join('ã€')}`;
            }

            // æ˜¾ç¤ºæç¤º
            statusEl.classList.add('show');

            // 3ç§’åè‡ªåŠ¨éšè—
            setTimeout(() => {
                statusEl.classList.remove('show');
            }, 3000);
        }

        // æ˜¾ç¤ºè®¢å•è¯¦æƒ…
        function showOrderDetails(orderData) {
            const detailsEl = document.getElementById('order-details');
            document.getElementById('detail-shipowner').textContent = orderData.èˆ¹ä¸œ;
            document.getElementById('detail-shipyard').textContent = orderData.èˆ¹å‚;
            document.getElementById('detail-ship-type-text').textContent = orderData.shipType;
            document.getElementById('detail-ship-type').style.backgroundColor = orderData.color;
            document.getElementById('detail-quantity').textContent = orderData.quantity;
            document.getElementById('detail-date').textContent = formatDate(orderData.date);
            document.getElementById('detail-country').textContent = orderData.country;

            detailsEl.classList.add('show');
        }

        // éšè—è®¢å•è¯¦æƒ…
        function hideOrderDetails() {
            document.getElementById('order-details').classList.remove('show');
        }

        // æ ¼å¼åŒ–æ—¥æœŸ
        function formatDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            if (!isNaN(date.getTime())) {
                return date.toISOString().split('T')[0];
            }
            return dateString;
        }
    </script>
</body>
</html>